kind: pipeline
type: docker
name: direct-deploy

trigger:
  branch:
    - main
    - master

steps:
  - name: build
    image: maven:3.9.8-eclipse-temurin-21
    commands:
      - mvn clean package -DskipTests

  - name: copy-jar
    image: appleboy/drone-scp
    settings:
      host:
        from_secret: ssh_host
      username:
        from_secret: ssh_user
      password:
        from_secret: ssh_password
      port: 22
      target: /opt/app/
      source:
        - target/*.jar
      strip_components: 1
    depends_on: [build]

  - name: nuclear-cleanup
    image: appleboy/drone-ssh
    settings:
      host:
        from_secret: ssh_host
      username:
        from_secret: ssh_user
      password:
        from_secret: ssh_password
      port: 22
      script:
        - |
          echo "=== NUCLEAR DISK CLEANUP ==="
          echo "BEFORE CLEANUP:"
          df -h
          
          # Ð–Ð•Ð¡Ð¢ÐšÐÐ¯ Ð¾Ñ‡Ð¸ÑÑ‚ÐºÐ° Docker
          echo "Cleaning Docker aggressively..."
          sudo docker system prune -af || echo "Docker not available"
          sudo docker volume prune -f || echo "No docker volumes"
          
          # ÐžÑ‡Ð¸ÑÑ‚ÐºÐ° ÑÐ¸ÑÑ‚ÐµÐ¼Ð½Ñ‹Ñ… Ð»Ð¾Ð³Ð¾Ð²
          echo "Cleaning system logs..."
          sudo journalctl --vacuum-time=1h
          sudo find /var/log -name "*.log" -type f -exec truncate -s 0 {} \; 2>/dev/null || true
          
          # ÐžÑ‡Ð¸ÑÑ‚ÐºÐ° Ð²Ñ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ñ… Ñ„Ð°Ð¹Ð»Ð¾Ð²
          echo "Cleaning temp files..."
          sudo rm -rf /tmp/*
          sudo rm -rf /var/tmp/*
          
          # ÐžÑ‡Ð¸ÑÑ‚ÐºÐ° ÐºÑÑˆÐ° Ð¿Ð°ÐºÐµÑ‚Ð¾Ð²
          echo "Cleaning package cache..."
          sudo apt clean
          sudo apt autoremove -y --purge
          
          # ÐžÑ‡Ð¸ÑÑ‚ÐºÐ° ÑÑ‚Ð°Ñ€Ñ‹Ñ… Ð»Ð¾Ð³Ð¾Ð² Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ñ
          echo "Cleaning app logs..."
          sudo find /opt/app -name "*.log" -type f -delete 2>/dev/null || true
          
          echo "AFTER CLEANUP:"
          df -h
          
          # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ ÑÐºÐ¾Ð»ÑŒÐºÐ¾ Ð¼ÐµÑÑ‚Ð° Ð¾ÑÐ²Ð¾Ð±Ð¾Ð´Ð¸Ð»Ð¾ÑÑŒ
          echo "Available space:"
          df -h /opt/app
    depends_on: [copy-jar]

  - name: check-if-we-have-space
    image: appleboy/drone-ssh
    settings:
      host:
        from_secret: ssh_host
      username:
        from_secret: ssh_user
      password:
        from_secret: ssh_password
      port: 22
      script:
        - |
          echo "=== CHECKING IF WE HAVE ENOUGH SPACE ==="
          df -h
          
          # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ ÑÐ²Ð¾Ð±Ð¾Ð´Ð½Ð¾Ðµ Ð¼ÐµÑÑ‚Ð¾ Ð² Ð¼ÐµÐ³Ð°Ð±Ð°Ð¹Ñ‚Ð°Ñ…
          FREE_SPACE=$(df /opt/app | awk 'NR==2 {print $4}')
          echo "Free space: ${FREE_SPACE}KB"
          
          # Ð•ÑÐ»Ð¸ Ð¼ÐµÐ½ÑŒÑˆÐµ 1GB - ÐºÑ€Ð¸Ñ‚Ð¸Ñ‡Ð½Ð¾
          if [ "$FREE_SPACE" -lt 1000000 ]; then
            echo "âŒ CRITICAL: Still less than 1GB free space!"
            echo "Need to manually clean up more space"
            exit 1
          else
            echo "âœ… Enough space available"
          fi
    depends_on: [nuclear-cleanup]

  - name: deploy-with-extreme-measures
    image: appleboy/drone-ssh
    settings:
      host:
        from_secret: ssh_host
      username:
        from_secret: ssh_user
      password:
        from_secret: ssh_password
      port: 22
      script:
        - |
          echo "=== DEPLOYING WITH EXTREME MEASURES ==="
          cd /opt/app
          
          # Ð–ÐµÑÑ‚ÐºÐ°Ñ Ð¾ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Ð’Ð¡Ð•Ð¥ Java Ð¿Ñ€Ð¾Ñ†ÐµÑÑÐ¾Ð²
          echo "Killing all Java processes..."
          sudo pkill -9 -f java || true
          sleep 5
          
          # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ñ‡Ñ‚Ð¾ Ð½Ð¸Ñ‡ÐµÐ³Ð¾ Ð½Ðµ Ð¾ÑÑ‚Ð°Ð»Ð¾ÑÑŒ
          if pgrep -f java > /dev/null; then
            echo "âŒ Java processes still running, cannot continue"
            ps aux | grep java
            exit 1
          fi
          
          # Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ Ñ Ð°Ð±ÑÐ¾Ð»ÑŽÑ‚Ð½Ñ‹Ð¼ Ð¼Ð¸Ð½Ð¸Ð¼ÑƒÐ¼Ð¾Ð¼
          echo "Starting application with bare minimum..."
          java -Xms16m -Xmx64m -jar ar-webapp-1.0.0.jar --server.port=2062 &
          APP_PID=$!
          echo "App PID: $APP_PID"
          
          # ÐœÐ¾Ð½Ð¸Ñ‚Ð¾Ñ€Ð¸Ð¼ ÐºÐ°Ð¶Ð´ÑƒÑŽ ÑÐµÐºÑƒÐ½Ð´Ñƒ
          for i in {1..60}; do
            if ps -p $APP_PID > /dev/null; then
              echo "âœ… Still running after $i seconds"
              sleep 1
            else
              echo "âŒ DIED after $i seconds"
              echo "=== Checking why it died ==="
              
              # ÐŸÑ€Ð¾Ð±ÑƒÐµÐ¼ Ð·Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚ÑŒ Ñ Ð²Ñ‹Ð²Ð¾Ð´Ð¾Ð¼ Ð¾ÑˆÐ¸Ð±Ð¾Ðº Ð² ÐºÐ¾Ð½ÑÐ¾Ð»ÑŒ
              echo "=== Trying to run with error output ==="
              java -Xms16m -Xmx64m -jar ar-webapp-1.0.0.jar --server.port=2062 2>&1 | head -100
              exit 1
            fi
          done
          
          echo "ðŸŽ‰ SUCCESS! Application running for 60 seconds"
          echo "Process info:"
          ps -p $APP_PID -o pid,vsz,rss,pcpu,comm
    depends_on: [check-if-we-have-space]